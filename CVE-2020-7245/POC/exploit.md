# CVE-2020-7245

## Description

Incorrect username validation in the registration process of CTFd v2.0.0 - v2.2.2 allows an attacker to take over an arbitrary account if the username is known and emails are enabled on the CTFd instance. To exploit the vulnerability, one must register with a username identical to the victim's username, but with white space inserted before and/or after the username. This will register the account with the same username as the victim. After initiating a password reset for the new account, CTFd will reset the victim's account password due to the username collision.

## Setup

1. Clone the repository

    ```bash
    git clone git@github.com:CTFd/CTFd.git
    ```

2. Change the directory

    ```bash
    cd CTFd
    ```

3. Fetch all the tags

    ```bash
    git fetch --all --tags
    ```

4. Checkout to the vulnerable version

    ```bash
    git checkout 2.2.2
    ```

5. Apply this patch, to allow CTFd to be built (no effect on exploit, just needed as some dependencies are not explicitly tagged, *thank python for it's lovely dependency management*)

    ```diff
    diff --git a/Dockerfile b/Dockerfile
    index ceaa9dc5..63316935 100644
    --- a/Dockerfile
    +++ b/Dockerfile
    @@ -1,6 +1,6 @@
     FROM python:3.7-alpine
     RUN apk update && \
    -    apk add python python-dev linux-headers libffi-dev gcc make musl-dev py-pip mysql-client git openssl-dev
    +    apk add python3 python3-dev linux-headers libffi-dev gcc make musl-dev py-pip mysql-client git openssl-dev
     RUN adduser -D -u 1001 -s /bin/bash ctfd
    
     WORKDIR /opt/CTFd
    diff --git a/requirements.txt b/requirements.txt
    index 2dfe1411..a2417cae 100644
    --- a/requirements.txt
    +++ b/requirements.txt
    @@ -1,4 +1,5 @@
     Flask==1.1.1
    +jinja2<3.1.0
     Werkzeug==0.16.0
     Flask-SQLAlchemy==2.4.1
     Flask-Caching==1.4.0
    @@ -20,6 +21,7 @@ netaddr==0.7.19
     redis==3.3.11
     datafreeze==0.1.0
     gevent==1.4.0
    +greenlet==0.4.15
     python-dotenv==0.10.3
     flask-restplus==0.13.0
     pathlib2==2.3.5
    ```

6. Build the project with docker

    ```bash
    docker compose up
    ```

7. Setup a SMTP Server, if you dont have something like that you can use [smtp4dev](https://github.com/rnwood/smtp4dev) like me, and setup a fake SMTP server, which will catch all the emails sent by CTFd.

    ```bash
    docker run --rm -it -p 5500:80 -p 2525:25 rnwood/smtp4dev
    ```

8. Open the CTFd instance in your browser, and setup the CTFd instance.

9. Create a user say with username `target`, email `target@test.com`, password `password`.

## Exploit

1. Create a user with username ` target`, email `nottarget@test.com`, password `notpassword`.

2. Now, initiate a password reset for the email `nottarget@test.com`.

3. Open the email recieved by nottarget, and click on the link, and reset the password, to say `hacked`.

4. Now, login with the username `target` and password `hacked`, and you will be able to login.

And now you have successfully exploited the vulnerability.

## Explanation

Basically, the issue was that we could create two users with the same username, by creating the other with a space before the username.
Due to this there was a username collision, and the password reset token was sent to the email of the user with the space before the username, allowing us to reset the password of the user with the original username.

This was fixed by [this commit](https://github.com/CTFd/CTFd/commit/f660ed1fb769126a2d149c26645bbde457a5c616). The main changes done were:

<details>
<summary>Patch</summary>

```diff
From f660ed1fb769126a2d149c26645bbde457a5c616 Mon Sep 17 00:00:00 2001
From: Kevin Chung <kchung@ctfd.io>
Date: Mon, 20 Jan 2020 14:22:06 -0500
Subject: [PATCH] Strip spaces on registration and have reset password use
 email address instead of names (#1218)

* Usernames are now properly stripped before being used in registration checks
* Reset password function now uses email addresses instead of user names for tokens
* Prevent MLC users from resetting their password
---
 CTFd/auth.py                 | 53 ++++++++++++++++++++++++------------
 CTFd/schemas/teams.py        |  1 +
 CTFd/schemas/users.py        |  2 ++
 CTFd/teams.py                |  2 +-
 CTFd/utils/email/__init__.py | 15 +++++-----
 tests/users/test_auth.py     | 23 ++++++++++++----
 tests/utils/test_email.py    |  8 ++++--
 7 files changed, 71 insertions(+), 33 deletions(-)

diff --git a/CTFd/auth.py b/CTFd/auth.py
index 5ca6d52eb2..99bb4621c3 100644
--- a/CTFd/auth.py
+++ b/CTFd/auth.py
@@ -98,7 +98,7 @@ def confirm(data=None):
 def reset_password(data=None):
     if data is not None:
         try:
-            name = unserialize(data, max_age=1800)
+            email_address = unserialize(data, max_age=1800)
         except (BadTimeSignature, SignatureExpired):
             return render_template(
                 "reset_password.html", errors=["Your link has expired"]
@@ -111,20 +111,35 @@ def reset_password(data=None):
         if request.method == "GET":
             return render_template("reset_password.html", mode="set")
         if request.method == "POST":
-            user = Users.query.filter_by(name=name).first_or_404()
-            user.password = request.form["password"].strip()
+            password = request.form.get("password", "").strip()
+            user = Users.query.filter_by(email=email_address).first_or_404()
+            if user.oauth_id:
+                return render_template(
+                    "reset_password.html",
+                    errors=[
+                        "Your account was registered via an authentication provider and does not have an associated password. Please login via your authentication provider."
+                    ],
+                )
+
+            pass_short = len(password) == 0
+            if pass_short:
+                return render_template(
+                    "reset_password.html", errors=["Please pick a longer password"]
+                )
+
+            user.password = password
             db.session.commit()
             log(
                 "logins",
                 format="[{date}] {ip} -  successful password reset for {name}",
-                name=name,
+                name=user.name,
             )
             db.session.close()
             return redirect(url_for("auth.login"))
 
     if request.method == "POST":
         email_address = request.form["email"].strip()
-        team = Users.query.filter_by(email=email_address).first()
+        user = Users.query.filter_by(email=email_address).first()
 
         get_errors()
 
@@ -134,7 +149,7 @@ def reset_password(data=None):
                 errors=["Email could not be sent due to server misconfiguration"],
             )
 
-        if not team:
+        if not user:
             return render_template(
                 "reset_password.html",
                 errors=[
@@ -142,7 +157,15 @@ def reset_password(data=None):
                 ],
             )
 
-        email.forgot_password(email_address, team.name)
+        if user.oauth_id:
+            return render_template(
+                "reset_password.html",
+                errors=[
+                    "The email address associated with this account was registered via an authentication provider and does not have an associated password. Please login via your authentication provider."
+                ],
+            )
+
+        email.forgot_password(email_address)
 
         return render_template(
             "reset_password.html",
@@ -159,9 +182,9 @@ def reset_password(data=None):
 def register():
     errors = get_errors()
     if request.method == "POST":
-        name = request.form["name"]
-        email_address = request.form["email"]
-        password = request.form["password"]
+        name = request.form.get("name", "").strip()
+        email_address = request.form.get("email", "").strip().lower()
+        password = request.form.get("password", "").strip()
 
         name_len = len(name) == 0
         names = Users.query.add_columns("name", "id").filter_by(name=name).first()
@@ -170,9 +193,9 @@ def register():
             .filter_by(email=email_address)
             .first()
         )
-        pass_short = len(password.strip()) == 0
+        pass_short = len(password) == 0
         pass_long = len(password) > 128
-        valid_email = validators.validate_email(request.form["email"])
+        valid_email = validators.validate_email(email_address)
         team_name_email_check = validators.validate_email(name)
 
         if not valid_email:
@@ -206,11 +229,7 @@ def register():
             )
         else:
             with app.app_context():
-                user = Users(
-                    name=name.strip(),
-                    email=email_address.lower(),
-                    password=password.strip(),
-                )
+                user = Users(name=name, email=email_address, password=password)
                 db.session.add(user)
                 db.session.commit()
                 db.session.flush()
diff --git a/CTFd/schemas/users.py b/CTFd/schemas/users.py
index d253911529..e9236c0bdf 100644
--- a/CTFd/schemas/users.py
+++ b/CTFd/schemas/users.py
@@ -55,6 +55,7 @@ def validate_name(self, data):
         name = data.get("name")
         if name is None:
             return
+        name = name.strip()
 
         existing_user = Users.query.filter_by(name=name).first()
         current_user = get_current_user()
@@ -95,6 +96,7 @@ def validate_email(self, data):
         email = data.get("email")
         if email is None:
             return
+        email = email.strip()
 
         existing_user = Users.query.filter_by(email=email).first()
         current_user = get_current_user()
```

</details>
